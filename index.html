<html lang="en">

<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS498 S&P500</title>
</head>

<body>
    <div class="container-md">
        <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h1">S&P 500: A History of the US Economy</p>
        </div>
        <div class="row">
            <div class="col-md-3 border-right bg-light">
                <h2 class="h2" id="year-title">1957: Inception</h2>
                <p>
                    <br> The index was expanded to its current 500 companies and was renamed the S&P 500 Stock Composite Index</br> 
                    <br> The initial list only included three industries: Industrials, Utilities, and Rails<br>
                    <br> The largest company at the time was Standard Oil of New Jersey with an $11B Market Cap</br>
                </p>
                <p></p>
                <button>Next: 1976</button>
            </div>
            <div class="col-md-9" id="my_dataviz">
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore.js">
    </script>
    <script>
        var margin = { top: 10, right: 10, bottom: 10, left: 10 },
            width = 800 - margin.left - margin.right,
            height = 445 - margin.top - margin.bottom;

        const x = d3.scaleLinear().rangeRound([0, width]);
        const y = d3.scaleLinear().rangeRound([0, height]);
        const color = d3.scaleOrdinal().domain(["Communication",
            , "Consumer Discretionary"
            , "Consumer Staples"
            , "Energy"
            , "Financials"
            , "Health Care"
            , "Industrials"
            , "Information Technology"
            , "Materials"
            , "Real Estate"
            , "Utilities"
            , "Rails"
            , "Transportation"]).range([
                "#1f77b4", "#aec7e8",
                "#ff7f0e", "#ffbb78",
                "#2ca02c", "#98df8a",
                "#d62728", "#ff9896",
                "#9467bd", "#c5b0d5",
                "#8c564b", "#c49c94",
                "#e377c2"
            ])

        // append the svg object to the body of the page
        var grandparent = d3.select("#my_dataviz")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")")
            .attr("class", "grandparent");
        
        data = init(1957)
        main()

        async function main(){
            await sleep(2000)
            changeYear('2018', data)
            await sleep(2000)
            changeYear('2008', data)
        }
        

        async function init(year) {
            data = await d3.csv('./data/CompanyDetail.csv')
            console.log(data)
            dataStrat = stratify(data.filter(row => row.Year == String(year) || row.Year == ''))
            var root = treemap(dataStrat);
            console.log(root)

            const leaf = grandparent.selectAll("g")
                .data(root.children)
                .enter()
                .append("g")
                .attr("transform", d => `translate(${d.x0},${d.y0})`);
            cells = leaf.append("rect")
                .attr("fill-opacity", 0.6)
                .attr("x", d => d.x0 * width)
                .attr("y", d => d.y0 * height)
                .attr("width", d => (d.x1 - d.x0) * width)
                .attr("height", d => (d.y1 - d.y0) * height)
                .attr("fill", d => color(d.data.id))

            leaf.append("text")
                .attr("class", "name")
                .attr("x", d => (d.x0 + (d.x1 - d.x0) / 8) * width)
                .attr("y", d => (d.y0 + (d.y1 - d.y0) / 2) * height)
                .text(d => d.data.id)
                .attr("display", d => typeof d.children !== 'undefined' ? "inline" : "none")
                .style("fill", "black")
                .attr("font-size", "12px")
            leaf.append("text")
                .attr("class", "percent")
                .attr("x", d => (d.x0 + (d.x1 - d.x0) / 8) * width)
                .attr("y", d => (d.y0 + (d.y1 - d.y0) / 2) * height + 16)
                .attr("display", d => typeof d.children !== 'undefined' ? "inline" : "none")
                .text(d => Math.floor(d.value) + "%")
                .style("fill", "black")
                .attr("font-size", "12px")

            return data

        }

        async function changeYear(year, data) {
            //data.then(function(data){
            console.log(data)
            const dataStrat2 = stratify(data.filter(row => row.Year == String(year) || row.Year == ''))
            const root2 = treemap(dataStrat2);
            console.log(root2)
            console.log("hey")
            //grandparent.selectAll("g")
            //    .data(root2.children)
            //    .exit()
            var rects = grandparent.selectAll("rect")
                .data(root2.children)
                .transition().duration(2000)
                .attr("fill-opacity", 0.6)
                .attr("x", d => d.x0 * width)
                .attr("y", d => d.y0 * height)
                .attr("width", d => (d.x1 - d.x0) * width)
                .attr("height", d => (d.y1 - d.y0) * height)
                .attr("fill", d => color(d.data.id))



            grandparent.selectAll(".name")
                .data(root2.children)
                .transition().duration(2000)
                .attr("x", d => (d.x0 + (d.x1 - d.x0) / 8) * width)
                .attr("y", d => (d.y0 + (d.y1 - d.y0) / 2) * height)
                .text(d => d.data.id)
                .attr("display", d => typeof d.children !== 'undefined' ? "inline" : "none")
                .style("fill", "black")
                .attr("font-size", "12px")

            grandparent.selectAll(".percent")
                .data(root2.children)
                .transition().duration(2000)
                .attr("class", "percent")
                .attr("x", d => (d.x0 + (d.x1 - d.x0) / 8) * width)
                .attr("y", d => (d.y0 + (d.y1 - d.y0) / 2) * height + 16)
                .attr("display", d => typeof d.children !== 'undefined' ? "inline" : "none")
                .text(d => Math.floor(d.value) + "%")
                .style("fill", "black")
                .attr("font-size", "12px")
            //})
            
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        console.log(data)
        var stratify = d3.stratify()
            .parentId(function (d) {
                return d.Parent;
            })
            .id(function (d) {
                return d.Id;
            });

        treemap = data => d3.treemap()
            (d3.hierarchy(data)
                .sum(d => parseFloat(d.data.AdjWeight))
                .sort((a, b) => b.id - a.id))


    </script>
</body>

</html>